@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Dashboard";
    int seq = 0;
    bool archived = Convert.ToBoolean(Context.Request.Cookies["_kj6ght"]);
}
@using static ProjectFollower.Utility.ProjectConstant.UserRoles
@model ProjectFollower.Models.ViewModels.ProjectVM
<main>
    @*
        <div class="alert alert-danger alert-dismissible fade show rounded mb-4" role="alert"><strong>Dikkat!</strong> Termini geçmiş 1 adet projeniz bulunmakta. <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button></div>
    *@
    <div id="mp-attention">
    </div>

    @*
        <div id="messageTxt"></div>
        <div class="form-inline">
            <input id="messageTextbox" />
            <input id="btnSend" class="btn btn-success" type="button"/>
        </div>
    *@
    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col-12">
                <div class="mb-3">
                    <h1>Projeler</h1>
                    <div class="text-zero top-right-button-container">
                        @if (User.IsInRole(Admin))
                        {
                            <a asp-controller="Home" asp-action="ProjectNew" type="button" class="btn btn-primary btn-lg top-right-button mr-1">YENİ PROJE EKLE</a>
                        }

                    </div>
                </div>

                <div class="mb-2">
                    <a class="btn pt-0 pl-0 d-inline-block d-md-none" data-toggle="collapse" href="#displayOptions"
                       role="button" aria-expanded="true" aria-controls="displayOptions">
                        Display Options
                        <i class="simple-icon-arrow-down align-middle"></i>
                    </a>
                    <div class="collapse d-md-block" id="displayOptions">
                        <div class="d-block d-md-inline-block">

                            <div class="search-sm d-inline-block float-md-left mr-1 mb-1 align-top">
                                <input placeholder="Ara..." id="tableSearch">
                            </div>
                        </div>
                        <div class="float-md-right">
                            <div class="form-group row mb-1">
                                <label class=" d-flex align-items-center text-muted mr-2"><b>Arşivlenmiş Projeler</b></label>
                                <div class="custom-switch custom-switch-secondary-inverse mb-2 mr-2">
                                    @if (archived)
                                    {
                                        <input class="custom-switch-input" id="archived" type="checkbox" checked>
                                    }
                                    else
                                    {
                                        <input class="custom-switch-input" id="archived" type="checkbox">
                                    }

                                    <label class="custom-switch-btn" for="archived"></label>
                                </div>

                            </div>
                        </div>
                        @if (User.IsInRole(Admin))
                        {
                            <div class="float-md-right mr-5">

                                <button class="btn btn-outline-dark btn-xs dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Kişi Filterelemesi</button>
                                <div class="dropdown-menu dropdown-menu-right " x-placement="bottom-end" style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(1291px, 96px, 0px);" id="user-filter">

                                </div>
                            </div>
                        }
                        @if (User.IsInRole(Admin))
                        {
                            <div class="float-md-right mr-2">

                                <button class="btn btn-outline-dark btn-xs dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Durum Filtrelemesi</button>
                                <div class="dropdown-menu dropdown-menu-right " x-placement="bottom-end" style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(1291px, 96px, 0px);">
                                    <a type="button" class="dropdown-item filter-status" href="#" id="0">Yeni</a>
                                    <a type="button" class="dropdown-item filter-status" href="#" id="1">Yapım Aşamasında</a>
                                    <a type="button" class="dropdown-item filter-status" href="#" id="2">Müşteri Onayında</a>
                                    <a type="button" class="dropdown-item filter-status" href="#" id="6">Beklemede</a>
                                    <a type="button" class="dropdown-item filter-status" href="#" id="3">Tamamlandı</a>
                                    <a type="button" class="dropdown-item filter-status" href="#" id="4">Arşivlendi</a>
                                    <a type="button" class="dropdown-item filter-status" href="#" id="5">Tümünü Göster</a>

                                </div>
                            </div>
                        }


                    </div>
                </div>
                <div class="separator mb-4"></div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="data-table-rows data-tables-hide-filter">
                    <table id="datatableRow" class="data-table data-tables-pagination responsive nowrap"
                           style="width:100%">
                        <thead>
                            <tr>
                                <th style="visibility: hidden;"></th>
                                <th>Firma Adı</th>
                                <th>Proje Adı</th>
                                <th>Oluşturma Tarihi</th>
                                <th>Deadline</th>
                                <th>Durum</th>
                                <th style="visibility: hidden;"></th>
                            </tr>
                        </thead>
                        <tbody class="list" id="tbody">
                            @*
                                <tr class="cardd">
                                    <td>
                                        <img src="img/orj/firmalar/elitdijital.png" alt="Fat Rascal" class="list-thumbnail responsive border-0 card-img-left" />
                                    </td>
                                    <td>
                                        <p class="list-item-heading">Elit Dijital Logo Tasarımı</p>
                                    </td>
                                    <td>
                                        <p>Elit Dijital</p>
                                    </td>
                                    <td>
                                        <p>05.01.2022</p>
                                    </td>
                                    <td>
                                        <p class="d-none">3</p><span class="badge badge-pill badge-primary">TAMAMLANDI</span>
                                    </td>
                                    <td class="text-center">
                                        <a href="#" type="button" class="btn btn-secondary btn-sm mb-1"><i class="glyph-icon simple-icon-info mr-1"></i>Detaylar</a>
                                    </td>
                                </tr>

                                <tr class="cardd">
                                    <td>
                                        <img src="img/orj/firmalar/poligon.jpg" alt="Fat Rascal" class="list-thumbnail responsive border-0 card-img-left" />
                                    </td>
                                    <td>
                                        <p class="list-item-heading">Poligon Logo Tasarımı</p>
                                    </td>
                                    <td>
                                        <p>Poligon Mühendislik</p>
                                    </td>
                                    <td>
                                        <p>08.02.2022</p>
                                    </td>
                                    <td>
                                        <p class="d-none">2</p><span class="badge badge-pill badge-secondary">MÜŞTERİ ONAYINDA</span>
                                    </td>
                                    <td class="text-center">
                                        <a asp-controller="Home" asp-Action="Details" type="button" class="btn btn-secondary btn-sm mb-1"><i class="glyph-icon simple-icon-info mr-1"></i>Detaylar</a>

                                    </td>
                                </tr>
                                <tr class="cardd">
                                    <td>
                                        <img src="img/orj/firmalar/manypoints.png" alt="Fat Rascal" class="list-thumbnail responsive border-0 card-img-left" />
                                    </td>
                                    <td>
                                        <p class="list-item-heading">Many Points Post</p>
                                    </td>
                                    <td>
                                        <p>Many Points</p>
                                    </td>
                                    <td>
                                        <p>07.01.2022</p>
                                    </td>
                                    <td>
                                        <p class="d-none">1</p><span class="badge badge-pill badge-warning">YAPIM AŞAMASINDA</span><span class="badge badge-pill badge-danger ml-3">Proje Gecikmiş!</span>
                                    </td>
                                    <td class="text-center">
                                        <a asp-controller="Home" asp-Action="Details" class="btn btn-secondary btn-sm mb-1"><i class="glyph-icon simple-icon-info mr-1"></i>Detaylar</a>
                                    </td>
                                </tr>
                                <tr class="cardd">
                                    <td>
                                        <img src="img/orj/firmalar/poligon.jpg" alt="Fat Rascal" class="list-thumbnail responsive border-0 card-img-left" />
                                    </td>
                                    <td>
                                        <p class="list-item-heading">Poligon Video Tasarımı</p>
                                    </td>
                                    <td>
                                        <p>Poligon Mühendislik</p>
                                    </td>
                                    <td>
                                        <p>10.01.2022</p>
                                    </td>
                                    <td>
                                        <p class="d-none">1</p><span class="badge badge-pill badge-info">YENİ</span>
                                    </td>
                                    <td class="text-center">
                                        <a asp-controller="Home" asp-Action="Details" type="button" class="btn btn-secondary btn-sm mb-1"><i class="glyph-icon simple-icon-info mr-1"></i>Detaylar</a>
                                    </td>
                                </tr>
                            *@
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</main>

@section scripts
{
    <script src="/js/vendor/jquery.validate/jquery.validate.min.js"></script>
    <script src="/js/vendor/jquery.validate/additional-methods.min.js"></script>
    <script src="/js/vendor/datatables-index.min.js"></script>
    <script src="~/js/projectlistHub.js"></script>
    <script>
        @*
        function voidAjx() {
            $('#datatableRow').DataTable({
                "ajax": "/jsonresult/getprojectlist/" + archived,
                "columns": [
                    { "data": "name" },
                    { "data": "customers.name" },
                    { "data": "item.creationDate" },
                    { "data": "item.endingDate" },
                    { "data": "item.status" }
                ]
            });
        };*@

        function voidAjx() {
            var completed = 0;
            $.ajax({
                type: "GET",
                url: "/jsonresult/getprojectlist/" + archived,
                contentType: "application/json",
                dataType: "json",
                success: function (data) {
                    changeMenuStyle();
                    $("#tbody").text("");

                    $.each(data.projects, function (i, item) {

                        var name = item.name;
                        var id = item.id;
                        var status = "";
                        var isDelayed = item.isDelayed;
                        var endingData = item.endingDate;
                        var createDate = item.creationDate;
                        var custImage = item.customers.imageUrl;
                        var custid = item.customers.id + '/img/';
                        var img = "/assets/customers/" + custid + custImage;
                        var delayedspan = '';
                        if (isDelayed == true) {
                            delayedspan = `<span class="badge badge-pill badge-danger ml-3">PROJE GECİKMİŞ!</span>`;
                            if (item.status < 2)
                                completed++;
                        }

                        var custName = item.customers.name;
                        var sequence = item.projectSequence;
                        var dateSequence = item.sequanceDate;

                        if (item.status == 0) {
                            status = `<span class="badge badge-pill badge-info">YENİ</span>` + delayedspan;
                        }
                        if (item.status == 1) {
                            status = `<span class="badge badge-pill badge-warning">YAPIM AŞAMASINDA</span>` + delayedspan;
                        }
                        if (item.status == 2) {
                            status = `<span class="badge badge-pill badge-secondary">MÜŞTERİ ONAYINDA</span>`;
                        }
                        if (item.status == 6) {
                            status = `<span class="badge badge-pill badge-primary">BEKLEMEDE</span>`;
                        }
                        if (item.status == 3) {
                            status = `<span class="badge badge-pill badge-success">TAMAMLANDI</span>`;
                        }
                        if (item.status == 4) {
                            status = `<span class="badge badge-pill badge-primary" style="background-color: #008aff !important;"><i class="fas fa-archive"></i>&nbsp;&nbsp;ARŞİVLENMİŞ</span>`;
                        }
                        var trcls = "";
                        if (i % 2 == 0) {
                            trcls='odd';
                        }
                        else {
                            trcls = 'even';
                        }
                        var htmlstr = `
                                                <tr class="cardd `+ trcls + `" id="` + id + `" role="row">
                                                    <td tabindex="0">
                                                        <img src="`+ img + `" alt="` + name + `" class="list-thumbnail responsive border-0 card-img-left" />
                                                    </td>
                                                    <td class="sorting_1">
                                                        <p>` + custName + `</p>
                                                    </td>
                                                    <td>
                                                        <p class="list-item-heading">`+ name + `</p>
                                                    </td>
                                                    <td>
                                                         <p class="d-none">`+ createDate.split(".").reverse().join("") + `</p><p>` + createDate + `</p>
                                                    </td>
                                                    <td>
                                                        <p class="d-none">`+ endingData.split(".").reverse().join("") + `</p> <p>` + endingData + `</p>
                                                    </td>
                                                    <td>
                                                        <p class="d-none">`+ item.status + `</p>` + status + `
                                                    </td>
                                                    <td class="text-center">
                                                        <a href="/proje-detaylari/`+ item.id + `" type="button" class="btn btn-secondary btn-sm mb-1" target="_blank"><i class="glyph-icon simple-icon-info mr-1"></i>Detaylar</a>
                                                    </td>
                                                </tr>
`;

                        $("#tbody").append(htmlstr);


                    });

                    var alertstr = `
                    <div class="alert alert-danger alert-dismissible fade show rounded mb-4" role="alert"><strong>Dikkat!</strong> Termini geçmiş `+ completed + ` adet projeniz bulunmakta. <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button></div>
`;

                        if (completed > 0)
                        $("#mp-attention").html(alertstr);

                    $(".sorting").removeClass("sorting");
                }
            });
            changeMenuStyle();
        }

        $(document).on("click", ".filter-status", function () {
            var completed = 0;
            var userId = this.id;
            if (userId == 5) {
                voidAjx();
            } else {
            $.ajax({
                type: "GET",
                url: "/jsonresult/getstatusbyfilter/" + userId,
                contentType: "application/json",
                dataType: "json",
                success: function (data) {
                    $("#tbody").text("");
                    $.each(data.projects, function (i, item) {
                        var name = item.name;
                        var id = item.id
                        var status = item.status;
                        var isDelayed = item.isDelayed;
                        var createDate = item.creationDate;
                        var endingData = item.endingDate;
                        var custImage = item.customers.imageUrl;
                        var custid = item.customers.id + '/img/';
                        var img = "/assets/customers/" + custid + custImage;
                        var delayedspan = '';
                        if (isDelayed == true) {
                            delayedspan = `<span class="badge badge-pill badge-danger ml-3">PROJE GECİKMİŞ!</span>`;
                            if (item.status < 2) {
                                completed++;
                            }


                        }

                        var custName = item.customers.name;
                        var sequence = item.projectSequence;
                        var dateSequence = item.sequanceDate;
                        //var comptype = item.companyType.name;
                        if (item.status == 0) {
                            status = `<span class="badge badge-pill badge-info">YENİ</span>` + delayedspan;
                        }
                        if (item.status == 1) {
                            status = `<span class="badge badge-pill badge-warning">YAPIM AŞAMASINDA</span>` + delayedspan;
                        }
                        if (item.status == 2) {
                            status = `<span class="badge badge-pill badge-secondary">MÜŞTERİ ONAYINDA</span>`;
                        }
                        if (item.status == 6) {
                            status = `<span class="badge badge-pill badge-primary">BEKLEMEDE</span>`;
                        }
                        if (item.status == 3) {

                            status = `<span class="badge badge-pill badge-success">TAMAMLANDI</span>`;
                        }

                        if (item.status == 4) {
                            status = `<span class="badge badge-pill badge-primary" style="background-color: #008aff !important;"><i class="fas fa-archive"></i>&nbsp;&nbsp;ARŞİVLENMİŞ</span>`;

                        }

                        var htmlstr = `
                                                <tr class="cardd" id="`+ id + `">
                                                    <td>
                                                        <img src="`+ img + `" alt="` + name + `" class="list-thumbnail responsive border-0 card-img-left" />
                                                    </td>
                                                    <td>
                                                        <p class="d-none dateSequence">`+ dateSequence + `</p> <p>` + custName + `</p>
                                                    </td>
                                                    <td>
                                                        <p class="list-item-heading">`+ name + `</p>
                                                    </td>
                                                    <td>
                                                        <p class="d-none">`+ createDate.split(".").reverse().join("") + `</p><p>` + createDate + `</p>
                                                    </td>
                                                    <td>
                                                        <p class="d-none">`+ endingData.split(".").reverse().join("") + `</p><p>` + endingData + `</p>
                                                    </td>
                                                    <td>
                                                        <p class="d-none">`+ item.status + `</p>` + status + `
                                                    </td>
                                                    <td class="text-center">
                                                        <a href="/proje-detaylari/`+ item.id + `" type="button" class="btn btn-secondary btn-sm mb-1" target="_blank"><i class="glyph-icon simple-icon-info mr-1"></i>Detaylar</a>
                                                    </td>
                                                </tr>
`;

                        $("#tbody").append(htmlstr);


                    });
                    var alertstr = `
                    <div class="alert alert-danger alert-dismissible fade show rounded mb-4" role="alert"><strong>Dikkat!</strong> Termini geçmiş `+ completed + ` adet projeniz bulunmakta. <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button></div>
`;

                    @*
                        if ((data.delayedProjects > 0) && (completed == 0))*@
                    if (completed > 0) {
                        $("#mp-attention").html(alertstr);
                    } else {
                        $("#mp-attention").html("");
                    }
                }
            });
            }
        });
        $(document).on("click", ".filter-users", function () {
            var completed = 0;
            var archived = '@archived';
            var userId = this.id;
            if (userId == 5) {
                voidAjx();
            } else {

            $.ajax({
                type: "GET",
                url: "/jsonresult/getuserbyfilter/" + userId + "/" + archived,
                contentType: "application/json",
                dataType: "json",
                success: function (data) {
                    $("#tbody").text("");

                    $.each(data.projects, function (i, item) {

                        var name = item.name;
                        var id = item.id;
                        var status = "";
                        var isDelayed = item.isDelayed;
                        var createDate = item.creationDate;
                        var endingData = item.endingDate;
                        var custImage = item.customers.imageUrl;
                        var custid = item.customers.id + '/img/';
                        var img = "/assets/customers/" + custid + custImage;
                        var delayedspan = '';
                        if (isDelayed == true) {
                            delayedspan = `<span class="badge badge-pill badge-danger ml-3">PROJE GECİKMİŞ!</span>`;
                            if (item.status < 2) {
                                completed++;
                            }


                        }

                        var custName = item.customers.name;
                        var sequence = item.projectSequence;
                        var dateSequence = item.sequanceDate;
                        //var comptype = item.companyType.name;
                        if (item.status == 0) {
                            status = `<span class="badge badge-pill badge-info">YENİ</span>` + delayedspan;
                        }
                        if (item.status == 1) {
                            status = `<span class="badge badge-pill badge-warning">YAPIM AŞAMASINDA</span>` + delayedspan;
                        }
                        if (item.status == 2) {
                            status = `<span class="badge badge-pill badge-secondary">MÜŞTERİ ONAYINDA</span>`;
                        }
                        if (item.status == 6) {
                            status = `<span class="badge badge-pill badge-primary">BEKLEMEDE</span>`;
                        }
                        if (item.status == 3) {

                            status = `<span class="badge badge-pill badge-success">TAMAMLANDI</span>`;
                        }

                        if (item.status == 4) {
                            status = `<span class="badge badge-pill badge-primary" style="background-color: #008aff !important;"><i class="fas fa-archive"></i>&nbsp;&nbsp;ARŞİVLENMİŞ</span>`;

                        }

                        var htmlstr = `
                                                <tr class="cardd" id="`+ id + `">
                                                    <td>
                                                        <img src="`+ img + `" alt="` + name + `" class="list-thumbnail responsive border-0 card-img-left" />
                                                    </td>
                                                    <td>
                                                        <p>` + custName + `</p>
                                                    </td>
                                                    <td>
                                                        <p class="list-item-heading">`+ name + `</p>
                                                    </td>
                                                    <td>
                                                        <p class="d-none">`+ createDate.split(".").reverse().join("") + `</p><p>` + createDate + `</p>
                                                    </td>
                                                    <td>
                                                        <p class="d-none">`+ endingData.split(".").reverse().join("") + `</p><p>` + endingData + `</p>
                                                    </td>
                                                    <td>
                                                        <p class="d-none">`+ item.status + `</p>` + status + `
                                                    </td>
                                                    <td class="text-center">
                                                        <a href="/proje-detaylari/`+ item.id + `" type="button" class="btn btn-secondary btn-sm mb-1" target="_blank"><i class="glyph-icon simple-icon-info mr-1"></i>Detaylar</a>
                                                    </td>
                                                </tr>
`;

                        $("#tbody").append(htmlstr);


                    });

                    var alertstr = `
                    <div class="alert alert-danger alert-dismissible fade show rounded mb-4" role="alert"><strong>Dikkat!</strong> Termini geçmiş `+ completed + ` adet projeniz bulunmakta. <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button></div>
`;

                    @*
                        if ((data.delayedProjects > 0) && (completed == 0))*@
                    if (completed > 0) {
                        $("#mp-attention").html(alertstr);
                    }




                }
            });
            }
            changeMenuStyle();
        });


        $(document).ready(function () {

            $("#tbody").html("");
            voidAjx();


            var archived = '@archived';
            function changeArcStatus() {
                $.ajax({
                    type: "GET",
                    url: "/jsonresult/changearcstatus/" + archived,
                    contentType: "application/json",
                    dataType: "json",
                    success: function (data) {
                        setTimeout(function () {
                            location.reload();
                        }, 500);
                    }
                });
            };

            if ($('#archived').is(":checked")) {
            }

            $('#archived').change(function () {
                if (this.checked) {
                    archived = true;
                    changeArcStatus();
                } else {
                    archived = false;
                    changeArcStatus();
                }
            });

            //var arcStatus = 0;
            $.ajax({
                type: "GET",
                url: "/jsonresult/getallusers/",
                contentType: "application/json",
                dataType: "json",
                success: function (data) {
                    $("#user-filter").text("");

                    $.each(data, function (i, item) {

                        var users = `<a type="button" class="dropdown-item filter-users" href="#" id="` + item.id+`">`+item.fullName+`</a>`;

                        $("#user-filter").append(users);
                    });
                    $("#user-filter").append(`<a type="button" class="dropdown-item filter-users" href="#" id="5">Tümünü Göster</a>`);

                }
            });



            /*
            $('#datatableRow').DataTable({
                "order": [[3, 'desc']]
            });*/


            changeMenuStyle();
        });
        function changeMenuStyle() {
            $('.yeni_item').html('<span class="badge badge-pill badge-info" style="font-size: x-small;">YENİ</span>');
            $('.yapim_item').html('<span class="badge badge-pill badge-warning" style="font-size: x-small;">YAPIM AŞAMASINDA</span>');
            $('.musteriony_item').html('<span class="badge badge-pill badge-secondary" style="font-size: x-small;">MÜŞTERİ ONAYINDA</span>');
            $('.beklemede_item').html('<span class="badge badge-pill badge-primary" style="font-size: x-small;">BEKLEMEDE</span>');
            $('.tamamlandi_item').html('<span class="badge badge-pill badge-success" style="font-size: x-small;">TAMAMLANDI</span>');

        }
    </script>
}